<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Time</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="navbar">
    <a href="shopping.html">Berbelanja</a>
    <a href="index.html">Catat List</a>
    <a href="riwayat.html">Riwayat</a>
  </div>

  <div class="navbar-judul">
    <h2>Saatnya Berbelanja</h2>
    </div>


  <!-- Tampilkan budget -->
  <div class="tampil_budget">
    <p id="tampilBudget"></p>
  </div>

  <h3>Daftar Barang</h3>
  <div id="listBarang"></div>

  <div class="barang_tambahan">
    <h3>Barang Tambahan</h3>
    <form id="isi_barang_tambahan">
      <label for="barang_tambah">Nama Barang</label><br>
      <input type="text" id="barang_tambah" name="barang_tambah" required><br>
      <label for="jumlah_tambah">Jumlah Barang</label><br>
      <input type="number" id="jumlah_tambah" name="jumlah_tambah" min="0.1" step="any" value="1" required>
      <label for="satuan"></label>
      <select id="satuan" name="satuan">
        <option value="pcs">pcs</option>
        <option value="liter">liter</option>
        <option value="kg">kg</option>
        <option value="ons">ons</option>
        <option value="lusin">lusin</option>
      </select>
      <br>
      <label for="harga_tambah">Harga</label><br>
      <input type="number" id="harga_tambah" name="harga_tambah" required>
      <br>
      <button type="submit" id="btnBarangTambah">Tambah</button>
    </form>
  </div>

  <div class="ringkasan">
    <h2>Total belanja</h2>
    <p id="total">Total :</p>
    <p id="sisa">Sisa :</p>
    <p id="kekurangan">Kekurangan :</p>
  </div>

  <div class="simpanList">
    <button type="button" id="btnDone">Selesai</button>
  </div>

<script>
  const listBarangDiv = document.getElementById("listBarang");
  const budget = localStorage.getItem("budget") || 0;
  document.getElementById("tampilBudget").textContent = "Budget Anda: Rp " + budget;

  let barangList = JSON.parse(localStorage.getItem("barangList")) || [];

  // Render barang ke bubble
  function renderBarang() {
    listBarangDiv.innerHTML = "";
    barangList.forEach((item, index) => {
      const bubble = document.createElement("div");
      bubble.className = "bubble";

bubble.innerHTML = `
  <div class="bubble-content">
    <input type="checkbox" class="centang" ${item.checked ? "checked" : ""}>
    <div class="info">
      <strong>${item.nama}</strong><br>
      Jumlah: <input type="number" class="jumlah" value="${item.jumlah}" min="0.1" step="any" required> ${item.satuan}<br>
      Harga Satuan: <input type="number" class="harga" value="${item.harga || ""}" min="0"><br>
      <strong>Total: Rp ${(item.jumlah * (item.harga || 0)).toLocaleString("id-ID")}</strong>
    </div>
  </div>
  <div class="aksi">
    <button class="edit">Edit</button>
    <button class="hapus">Hapus</button>
  </div>
`;

      // Checkbox
      bubble.querySelector(".centang").addEventListener("change", e => {
        item.checked = e.target.checked;
        updateRingkasan();
      });

// Jumlah
bubble.querySelector(".jumlah").addEventListener("input", e => {
  // Ganti koma menjadi titik, lalu parse ke desimal
  item.jumlah = parseFloat(e.target.value.replace(",", ".")) || 0;

  const totalEl = bubble.querySelector(".info strong:last-of-type"); 
  totalEl.textContent = "Total: Rp " + (item.jumlah * (item.harga || 0)).toLocaleString("id-ID");

  updateRingkasan();
});


// Harga
bubble.querySelector(".harga").addEventListener("input", e => {
  item.harga = parseInt(e.target.value) || 0;
  const totalEl = bubble.querySelector(".info strong:last-of-type"); 
  totalEl.textContent = "Total: Rp " + (item.jumlah * (item.harga || 0)).toLocaleString("id-ID");
  updateRingkasan();
});

      // Edit tombol
 bubble.querySelector(".edit").addEventListener("click", () => {
  const newJumlah = prompt("Masukkan jumlah baru:", item.jumlah);
  if (newJumlah !== null) {
    // Ganti koma dengan titik, lalu parse ke decimal
    const jumlahDecimal = parseFloat(newJumlah.replace(",", "."));
    if (!isNaN(jumlahDecimal)) {
      item.jumlah = jumlahDecimal;
      renderBarang();
      updateRingkasan();
    } else {
      alert("Masukkan angka yang valid (boleh desimal)!");
    }
  }
});


      // Hapus tombol
      bubble.querySelector(".hapus").addEventListener("click", () => {
        barangList.splice(index, 1);
        renderBarang();
        updateRingkasan();
      });

      listBarangDiv.appendChild(bubble);
    });
  }

  // Barang tambahan
  document.getElementById("isi_barang_tambahan").addEventListener("submit", function(e) {
    e.preventDefault();
    const nama = document.getElementById("barang_tambah").value;
    const jumlah = parseInt(document.getElementById("jumlah_tambah").value);
    const satuan = document.getElementById("satuan").value;
    const harga = parseInt(document.getElementById("harga_tambah").value);

    barangList.push({ nama, jumlah, satuan, harga, checked: false });
    renderBarang();
    updateRingkasan();
    this.reset();
  });

  // Ringkasan
  const totalEl = document.getElementById("total");
  const sisaEl = document.getElementById("sisa");
  const kekuranganEl = document.getElementById("kekurangan");

  function updateRingkasan() {
    let total = 0;
    barangList.forEach(item => {
      if (item.checked) {
        total += (item.jumlah || 0) * (item.harga || 0);
      }
    });
    const sisa = budget - total;
    const kekurangan = total > budget ? total - budget : 0;

    totalEl.textContent = "Total: Rp " + total.toLocaleString("id-ID");
    sisaEl.textContent = "Sisa: Rp " + (sisa >= 0 ? sisa.toLocaleString("id-ID") : 0);
    kekuranganEl.textContent = "Kekurangan: Rp " + kekurangan.toLocaleString("id-ID");
  }

  // Simpan riwayat
  document.getElementById("btnDone").addEventListener("click", () => {
    if (barangList.length === 0) {
      alert("Belum ada barang!");
      return;
    }
    const total = barangList.reduce((sum, item) => sum + (item.jumlah || 0) * (item.harga || 0), 0);
    const tanggal = new Date().toLocaleString("id-ID", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });

    const riwayatItem = { tanggal, budget, total, barangList };
    let riwayat = JSON.parse(localStorage.getItem("riwayatBelanja")) || [];
    riwayat.push(riwayatItem);
    localStorage.setItem("riwayatBelanja", JSON.stringify(riwayat));

    window.location.href = "riwayat.html";
  });

  // Awal load
  renderBarang();
  updateRingkasan();
</script>
</body>
</html>